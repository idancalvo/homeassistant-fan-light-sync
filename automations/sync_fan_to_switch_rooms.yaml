- id: 'xxxxxxxxxxxx1'
  alias: Sync Fan to Switch Rooms
  description: >
    Synchronize switches based on fan state changes,
    including loop prevention.
  mode: single
  variables:
    switch_map:
      fan.bedroom_fan: switch.bedroom_switch_fan
      #fan.kidsroom_fan: switch.kidsroom_switch_fan
      #fan.playroom_fan: switch.playroom_switch_fan

  trigger:
    - platform: state
      entity_id:
        - fan.bedroom_fan
        #- fan.kidsroom_fan
        #- fan.playroom_fan

  condition:
    - condition: template
      value_template: "{{ trigger.to_state.context.parent_id == none }}"

   action:
    - choose:
        - conditions:
            - condition: template
              value_template: >
                {{ trigger.to_state.state == 'on' and
                   states(switch_map[trigger.entity_id]) != 'on' }}
          sequence:
            - service: switch.turn_on
              target:
                entity_id: "{{ switch_map[trigger.entity_id] }}"

        - conditions:
            - condition: template
              value_template: >
                {{ trigger.to_state.state == 'off' and
                   states(switch_map[trigger.entity_id]) != 'off' }}
          sequence:
            - service: switch.turn_off
              target:
                entity_id: "{{ switch_map[trigger.entity_id] }}"
